<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>04-Remix</title>
    <link
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>
      <center>
        CO<sub>2</sub> Emissions from 1990-2011 | Pooja Patel | 04-Remix
      </center>
    </h1>
    <p style="font-size: 24px;">
     <center> For this assignment I decided to remix a visualization about CO<sub>2</sub> emissions from The World Bank. 
      The original visualizatons included a bar chart and line chart of global data and then a map. 
      For my remix, the data required some re-formatting and I chose to shorten the dataset to only include years from 1990-2011 (the years with the most filled in data). 
      The values in the dataset include the Country, Country Code, Continent, Region, Year, Emissions Per Capita, and Emissions (thousand metric tons).</center> 
      <br><br>
      Below is a remix of the map that utilizes a different color encoding and scale. To use the map visualization, first select the year that you wish to look at using the slider and then hover over the
      countries to see the emissions data relevant to the country in the selected year. Below the map are two linked visualization, a donut chart and bar chart.
      <br><br>
    </p>
    <div
      class="d1"
      style="width: 250px; float:left; height:25px; background:#648FFF;color:white;"
    >
      <center>&lt;2.5e5</center>
    </div>
    <div
      class="d2"
      style="width: 250px; float:left; height:25px; background:#DC267F;color:white;"
    >
      <center>2.5e5-1e6</center>
    </div>
    <div
      class="d3"
      style="width: 250px; float:left; height:25px; background:#FE6100;color:white;"
    >
      <center>1e6-5e6</center>
    </div>
    <div
      class="d4"
      style="width: 250px; float:left; height:25px; background:#FFB000;color:white;"
    >
      <center>&gt;5e6</center>
    </div>
    <div
      class="d5"
      style="width: 250px; float:left; height:25px; background:lightgrey;color:white;"
    >
      <center>n/a</center>
    </div>
    <h6>
      <br />
    </h6>
    <div
      class="c1"
      style="width: 100px; float:left; height:25px; background:#F0E442;color:white;"
    >
      <center>Africa</center>
    </div>
    <div
      class="c2"
      style="width: 100px; float:left; height:25px; background:#E69F00;color:white;"
    >
      <center>Americas</center>
    </div>
    <div
      class="c3"
      style="width: 100px; float:left; height:25px; background:#CC79A7;color:white;"
    >
      <center>Asia</center>
    </div>
    <div
      class="c4"
      style="width: 100px; float:left; height:25px; background:#D55E00;color:white;"
    >
      <center>Australia</center>
    </div>
    <div
      class="c5"
      style="width: 100px; float:left; height:25px; background:#009E73;color:white;"
    >
      <center>Europe</center>
    </div>

    <h6>
      <br />
    </h6>
    <div id="nav">
      <p>
        <br />
        <input type="radio" name="data-type" value="emissions" checked hidden />
      </p>
    </div>
    <section class="container">
      <p>
        Year = <span id="year-val"></span>
        <input id="year" type="range" step="1" />
      </p>
      <div class="chart-container">
        <svg id="map"></svg>
      </div>

      <div class="chart-container">
    <p>
      Below are the two linked visualizations, a donut chart and bar chart. 
      <br>
      The donut chart is linked to the year that was selected using the slider above. To use the donut
      chart you can select a year and then hover over the different slices to get data on each country. The slices in the pie chart are encoded by color based on the continent the 
      country belonngs to. Note: North America and South America were combined into 'Americas'.
      <br><br>
      The bar chart is linked to the map. To use the bar chart, first click on a country on the map.
      The country that was clicked on will then have the emission data of that country from 1990-2011 displayed on the bar chart.
      If the country did not have any data available for that year then, there will be no bar present for that year.
      <br><br>
    </p>
        <svg id="pie"></svg>
        <svg id="bar"></svg>
      </div>
    </section>
    <div class="tooltip"></div>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script>
      // draw pie
      function createPie(width, height) {
        var pie = d3
          .select("#pie")
          .attr("width", 400)
          .attr("height", 400);

        pie
          .append("g")
          .attr(
            "transform",
            "translate(" + width / 2 + ", " + height / 1.5 + ")"
          )
          .classed("chart", true);

        pie
          .append("text")
          .attr("x", width / 2)
          .attr("y", "1em")
          .attr("font-size", "1.5em")
          .style("text-anchor", "middle")
          .classed("pie-title", true);
      }

      function drawPie(data, currentYear) {
        var pie = d3.select("#pie");
        var arcs = d3
          .pie()
          .sort((a, b) => {
            if (a.continent < b.continent) return -1;
            if (a.continent > b.continent) return 1;
            return a.emissions - b.emissions;
          })
          .value(d => d.emissions);

        var path = d3
          .arc()
          .outerRadius(+pie.attr("height") / 2 - 50)
          .innerRadius(70);

        var yearData = data.filter(d => d.year === currentYear);
        var continents = [];
        for (var i = 0; i < yearData.length; i++) {
          var continent = yearData[i].continent;
          if (!continents.includes(continent)) {
            continents.push(continent);
          }
        }

        var colorScale = d3
          .scaleOrdinal()
          .domain(continents)
          .range(["#CC79A7", "#009E73", "#F0E442", "#E69F00", "#D55E00"]);

        var update = pie
          .select(".chart")
          .selectAll(".arc")
          .data(arcs(yearData));

        update.exit().remove();

        update
          .enter()
          .append("path")
          .classed("arc", true)
          .attr("stroke", "#240f07")
          .attr("stroke-width", "0.25px")
          .merge(update)
          .attr("fill", d => colorScale(d.data.continent))
          .attr("d", path);

        pie
          .select(".pie-title")
          .attr("x", 150)
          .attr("y", 20)
          .text("Country emissions in  " + currentYear);
      }

      // draw bar
      function createBar(width, height) {
        var bar = d3
          .select("#bar")
          .attr("width", 500)
          .attr("height", 300);

        bar.append("g").classed("x-axis", true);

        bar.append("g").classed("y-axis", true);

        bar
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("x", -height / 2)
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .style("font-size", "1em")
          .classed("y-axis-label", true);

        bar
          .append("text")
          .attr("x", width / 2)
          .attr("y", "1em")
          .attr("font-size", "1.5em")
          .style("text-anchor", "middle")
          .classed("bar-title", true);
      }

      function highlightBars(year) {
        d3.select("#bar")
          .selectAll("rect")
          .attr("fill", d => (d.year === year ? "#648FFF" : "#648FFF"));
      }

      function drawBar(data, dataType, country) {
        var bar = d3.select("#bar");
        var padding = {
          top: 40,
          right: 0,
          bottom: 30,
          left: 110
        };
        var barPadding = 1;
        var width = +bar.attr("width");
        var height = +bar.attr("height");
        var countryData = data
          .filter(d => d.country === country)
          .sort((a, b) => a.year - b.year);

        var xScale = d3
          .scaleLinear()
          .domain(d3.extent(data, d => d.year))
          .range([padding.left, width - padding.right]);

        var yScale = d3
          .scaleLinear()
          .domain([0, d3.max(countryData, d => d[dataType])])
          .range([height - padding.bottom, padding.top]);

        var barWidth = xScale(xScale.domain()[0] + 1) - xScale.range()[0];

        var xAxis = d3.axisBottom(xScale).tickFormat(d3.format(".0f"));

        d3.select(".x-axis")
          .attr("transform", "translate(0, " + (height - padding.bottom) + ")")
          .call(xAxis);

        var yAxis = d3.axisLeft(yScale);

        d3.select(".y-axis")
          .attr(
            "transform",
            "translate(" + (padding.left - barWidth / 2) + ",0)"
          )
          .transition()
          .call(yAxis);

        var barTitle = country ? "" + country : " ";

        d3.select(".bar-title").text(barTitle);

        var t = d3.transition();

        var update = bar.selectAll(".bar").data(countryData);

        update
          .exit()
          .transition(t)
          .attr("y", height - padding.bottom)
          .attr("height", 0)
          .remove();

        update
          .enter()
          .append("rect")
          .classed("bar", true)
          .attr("y", height - padding.bottom)
          .attr("height", 0)
          .merge(update)
          .attr("x", d => (xScale(d.year) + xScale(d.year - 1)) / 2)
          .attr("width", barWidth - barPadding)
          .transition(t)
          .attr("y", d => yScale(d[dataType]))
          .attr("height", d => height - padding.bottom - yScale(d[dataType]));
      }

      // draw map
      function createMap(width, height) {
        d3.select("#map")
          .attr("width", 700)
          .attr("height", 500)
          .append("text")
          .attr("x", width / 2)
          .attr("y", "1em")
          .attr("font-size", "1.5em")
          .style("text-anchor", "middle")
          .classed("map-title", true);
      }

      function drawMap(geoData, climateData, year, dataType) {
        var map = d3.select("#map");

        var projection = d3
          .geoMercator()
          .scale(120)
          .translate([+map.attr("width") / 2, +map.attr("height") / 1.4]);

        var path = d3.geoPath().projection(projection);

        d3.select("#year-val").text(year);

        geoData.forEach(d => {
          var countries = climateData.filter(row => row.countryCode === d.id);
          var name = "";
          if (countries.length > 0) name = countries[0].country;
          d.properties = countries.find(c => c.year === year) || {
            country: name
          };
        });

        var colors = ["#648FFF", "#DC267F", "#FE6100", "#FFB000"];

        var domains = {
          emissions: [0, 2.5e5, 1e6, 5e6],
          emissionsPerCapita: [0, 0.5, 2, 10]
        };

        var mapColorScale = d3
          .scaleLinear()
          .domain(domains[dataType])
          .range(colors);

        var update = map.selectAll(".country").data(geoData);

        update
          .enter()
          .append("path")
          .classed("country", true)
          .attr("d", path)
          .on("click", function() {
            var currentDataType = d3.select("input:checked").property("value");
            var country = d3.select(this);
            var isActive = country.classed("active");
            var countryName = isActive
              ? ""
              : country.data()[0].properties.country;
            drawBar(climateData, currentDataType, countryName);
            highlightBars(+d3.select("#year").property("value"));
            d3.selectAll(".country").classed("active", false);
            country.classed("active", !isActive);
          })
          .merge(update)
          .transition()
          .attr("fill", d => {
            var val = d.properties[dataType];
            return val ? mapColorScale(val) : "#ccc";
          });
      }

      function graphTitle(str) {
        return str.replace(/[A-Z]/g, c => " " + c.toLowerCase());
      }

      // combine
      d3.queue()
        .defer(d3.json, "//unpkg.com/world-atlas@1.1.4/world/50m.json")
        .defer(d3.csv, "./data.csv", function(row) {
          return {
            continent: row.Continent,
            country: row.Country,
            countryCode: row["Country Code"],
            emissions: +row["Emissions"],
            emissionsPerCapita: +row["Emissions Per Capita"],
            region: row.Region,
            year: +row.Year
          };
        })
        .await(function(error, mapData, data) {
          if (error) throw error;

          var extremeYears = d3.extent(data, d => d.year);
          var currentYear = extremeYears[0];
          var currentDataType = d3
            .select('input[name="data-type"]:checked')
            .attr("value");
          var geoData = topojson.feature(mapData, mapData.objects.countries)
            .features;

          var width = +d3.select(".chart-container").node().offsetWidth;
          var height = 300;

          createMap(width, width * 0.9);
          createBar(width, height);
          createPie(width, height);
          drawMap(geoData, data, currentYear, currentDataType);
          drawPie(data, currentYear);
          drawBar(data, currentDataType, "");

          d3.select("#year")
            .property("min", currentYear)
            .property("max", extremeYears[1])
            .property("value", currentYear)
            .on("input", () => {
              currentYear = +d3.event.target.value;
              drawMap(geoData, data, currentYear, currentDataType);
              drawPie(data, currentYear);
              highlightBars(currentYear);
            });

          d3.selectAll('input[name="data-type"]').on("change", () => {
            var active = d3.select(".active").data()[0];
            var country = active ? active.properties.country : "";
            currentDataType = d3.event.target.value;
            drawMap(geoData, data, currentYear, currentDataType);
            drawBar(data, currentDataType, country);
          });

          d3.selectAll("svg").on("mousemove touchmove", updateTooltip);

          function updateTooltip() {
            var tooltip = d3.select(".tooltip");
            var tgt = d3.select(d3.event.target);
            var isCountry = tgt.classed("country");
            var isBar = tgt.classed("bar");
            var isArc = tgt.classed("arc");
            var dataType = d3.select("input:checked").property("value");
            var units =
              dataType === "emissions" ? " thousand tons" : "tons per capita";
            var data;
            var percentage = "";
            if (isCountry) data = tgt.data()[0].properties;
            if (isArc) {
              data = tgt.data()[0].data;
              percentage = `<p>Percentage of total: ${getPercentage(
                tgt.data()[0]
              )}</p>`;
            }
            if (isBar) data = tgt.data()[0];
            tooltip
              .style("opacity", +(isCountry || isArc || isBar))
              .style(
                "left",
                d3.event.pageX - tooltip.node().offsetWidth / 2 + "px"
              )
              .style(
                "top",
                d3.event.pageY - tooltip.node().offsetHeight - 10 + "px"
              );
            if (data) {
              var dataValue = data[dataType]
                ? data[dataType].toLocaleString() + " " + units
                : "Data Not Available";
              tooltip.html(`
              <p>Country: ${data.country}</p>
              <p>${formatDataType(dataType)}: ${dataValue}</p>
              <p>Year: ${data.year || d3.select("#year").property("value")}</p>
              ${percentage}
            `);
            }
          }
        });

      function formatDataType(key) {
        return (
          key[0].toUpperCase() + key.slice(1).replace(/[A-Z]/g, c => " " + c)
        );
      }

      function getPercentage(d) {
        var angle = d.endAngle - d.startAngle;
        var fraction = (100 * angle) / (Math.PI * 2);
        return fraction.toFixed(2) + "%";
      }
    </script>
  </body>
</html>
